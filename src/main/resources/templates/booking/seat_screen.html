<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chọn ghế</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #111;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
        }
        .screen { width: 60%; height: 5px; background: orange; margin: 20px auto; border-radius: 5px; }
        .seats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; justify-items: center; margin-bottom: 15px; }
        .seat-btn { width: 50px; height: 50px; border-radius: 8px; border: 2px solid #444; background: #222; color: #ccc; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .seat-btn:hover:not(.occupied) { border-color: orange; transform: scale(1.05); color: #fff; }
        .seat-btn.selected { background: orange; border-color: orange; color: #000; }
        .seat-btn.occupied { background: #333; color: #555; cursor: not-allowed; opacity: 0.6; }
        .seat-btn.seat-vip { background: #8b0000; border-color: #b22222; color: #fff; }
        .seat-btn.seat-couple { background: #4b0082; border-color: #8a2be2; color: #fff; }
        .summary { margin-top: 20px; padding: 15px; background: #222; border-radius: 8px; }
        .summary span { font-weight: bold; color: orange; }
        .btn-submit { width: 100%; padding: 12px; background: orange; color: #000; border: none; border-radius: 8px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
        h5 { margin-top: 20px; color: #ffa500; }
    </style>
</head>
<body>

<div class="container">
    <h3>Chọn ghế ngồi</h3>
    <div class="screen"></div>

    <form th:action="@{/book}" method="post" id="bookingForm">
        <input type="hidden" name="showtimeId" th:value="${showtimeId}" />
        <div id="seatInputs"></div>

        <h5>Ghế Thường (80.000₫)</h5>
        <div class="seats-grid">
            <button type="button"
                    th:each="seat : ${availableSeats}"
                    th:if="${seat.seatType == 'Thường'}"
                    class="seat-btn"
                    th:text="${seat.seatNumber}"
                    th:data-seat-id="${seat.seatId}"
                    th:data-seat-type="${seat.seatType}"
                    th:classappend="${seat.booked} ? ' occupied' : ''"
                    th:attr="disabled=${seat.booked} ? 'disabled' : null">
            </button>
        </div>

        <!-- KHU GHẾ VIP -->
        <h5>Ghế VIP (120.000₫)</h5>
        <div class="seats-grid">
            <button type="button"
                    th:each="seat : ${availableSeats}"
                    th:if="${seat.seatType == 'VIP'}"
                    class="seat-btn seat-vip"
                    th:text="${seat.seatNumber}"
                    th:data-seat-id="${seat.seatId}"
                    th:data-seat-type="${seat.seatType}"
                    th:classappend="${seat.booked} ? ' occupied' : ''"
                    th:attr="disabled=${seat.booked} ? 'disabled' : null">
            </button>
        </div>

        <!-- KHU GHẾ COUPLE -->
        <h5>Ghế Couple (150.000₫)</h5>
        <div class="seats-grid">
            <button type="button"
                    th:each="seat : ${availableSeats}"
                    th:if="${seat.seatType == 'Couple'}"
                    class="seat-btn seat-couple"
                    th:text="${seat.seatNumber}"
                    th:data-seat-id="${seat.seatId}"
                    th:data-seat-type="${seat.seatType}"
                    th:classappend="${seat.booked} ? ' occupied' : ''"
                    th:attr="disabled=${seat.booked} ? 'disabled' : null">
            </button>
        </div>

        <div class="summary">
            <p>Ghế đã chọn: <span id="selectedSeats">Chưa chọn</span></p>
            <p>Số lượng: <span id="seatCount">0</span></p>
            <p>Tổng tiền: <span id="totalAmount">0₫</span></p>
        </div>

        <button type="submit" class="btn-submit" id="submitBtn" disabled>Đặt vé ngay</button>
    </form>
</div>

<script>
    const PRICES = { Thường : 80000, VIP: 120000, Couple: 150000 };
    const selectedSeats = [];
    const seatInputsDiv = document.getElementById('seatInputs');
    const selectedSeatsDisplay = document.getElementById('selectedSeats');
    const seatCountDisplay = document.getElementById('seatCount');
    const totalAmountDisplay = document.getElementById('totalAmount');
    const submitBtn = document.getElementById('submitBtn');

    document.querySelectorAll('.seat-btn:not(.occupied)').forEach(btn => {
        btn.addEventListener('click', () => {
            const seatId = btn.getAttribute('data-seat-id');
            const seatNumber = btn.textContent.trim();
            const seatType = btn.getAttribute('data-seat-type');

            btn.classList.toggle('selected');

            if(btn.classList.contains('selected')) {
                selectedSeats.push({ id: seatId, number: seatNumber, type: seatType });
            } else {
                const idx = selectedSeats.findIndex(s => s.id === seatId);
                if(idx > -1) selectedSeats.splice(idx,1);
            }

            updateSummary();
        });
    });

    function updateSummary() {
        selectedSeatsDisplay.textContent = selectedSeats.length ? selectedSeats.map(s => s.number).join(', ') : 'Chưa chọn';
        seatCountDisplay.textContent = selectedSeats.length;

        let total = selectedSeats.reduce((sum, s) => sum + PRICES[s.type], 0);
        totalAmountDisplay.textContent = total.toLocaleString('vi-VN') + '₫';

        seatInputsDiv.innerHTML = '';
        selectedSeats.forEach(s => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'seatIds';
            input.value = s.id;
            seatInputsDiv.appendChild(input);
        });

        submitBtn.disabled = selectedSeats.length === 0;
    }

    document.getElementById('bookingForm').addEventListener('submit', e => {
        if(selectedSeats.length === 0) {
            e.preventDefault();
            alert('Vui lòng chọn ít nhất 1 ghế!');
        }
    });
</script>

</body>
</html>
